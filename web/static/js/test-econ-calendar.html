<!DOCTYPE html>
<html>
<head>
    <title>Economic Calendar Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #0f172a; color: #e2e8f0; }
        .log { margin: 5px 0; padding: 5px; background: #1e293b; border-radius: 4px; }
        .error { color: #ef4444; }
        .success { color: #22c55e; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <h1>Economic Calendar Test</h1>
    <div id="logs"></div>
    <h2>Generated Events</h2>
    <div id="events"></div>

<script>
const logs = document.getElementById('logs');
function log(msg, type = 'info') {
    const div = document.createElement('div');
    div.className = `log ${type}`;
    div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logs.appendChild(div);
}

// Copy the schedule data
const ECONOMIC_EVENTS_SCHEDULE = [
    { day: 3, time: '08:30', name: 'Initial Jobless Claims', country: 'US', impact: 'medium', type: 'employment' },
    { name: 'Nonfarm Payrolls', country: 'US', impact: 'high', type: 'employment', dayOfMonth: 1 },
    { name: 'Unemployment Rate', country: 'US', impact: 'high', type: 'employment', dayOfMonth: 1 },
    { name: 'CPI (MoM)', country: 'US', impact: 'high', type: 'inflation', dayOfMonth: 10 },
    { name: 'CPI (YoY)', country: 'US', impact: 'high', type: 'inflation', dayOfMonth: 10 },
    { name: 'PPI (MoM)', country: 'US', impact: 'medium', type: 'inflation', dayOfMonth: 12 },
    { name: 'Core CPI', country: 'US', impact: 'high', type: 'inflation', dayOfMonth: 10 },
    { name: 'Retail Sales', country: 'US', impact: 'medium', type: 'economic', dayOfMonth: 15 },
    { name: 'FOMC Meeting', country: 'US', impact: 'high', type: 'interest-rate', dayOfMonth: 18 },
    { name: 'GDP (QoQ)', country: 'US', impact: 'high', type: 'gdp', dayOfMonth: 25 },
];

const MOCK_EVENT_HISTORY = {
    'Nonfarm Payrolls': { previous: '256K', forecast: '185K' },
    'CPI (MoM)': { previous: '0.3%', forecast: '0.2%' },
    'Initial Jobless Claims': { previous: '217K', forecast: '215K' },
};

function getRandomMarketTime() {
    const hours = [8, 9, 10, 13, 14, 16];
    const hour = hours[Math.floor(Math.random() * hours.length)];
    const minute = Math.random() > 0.5 ? '00' : '30';
    return `${hour.toString().padStart(2, '0')}:${minute}`;
}

function generateEconomicEvents() {
    const events = [];
    const now = new Date();
    const currentHour = now.getHours();
    
    log(`Generating events starting from ${now.toDateString()}`, 'info');
    log(`Current day of week: ${now.getDay()} (0=Sun, 3=Wed)`, 'info');
    log(`Current day of month: ${now.getDate()}`, 'info');
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(now);
        date.setDate(date.getDate() + i);
        
        const dayOfWeek = date.getDay();
        const dayOfMonth = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        const dateStr = `${year}-${month.toString().padStart(2, '0')}-${dayOfMonth.toString().padStart(2, '0')}`;
        
        if (dayOfWeek === 0 || dayOfWeek === 6) {
            log(`Day ${i}: ${dateStr} - Skipping weekend`, 'info');
            continue;
        }
        
        log(`Day ${i}: ${dateStr} (weekday=${dayOfWeek}, monthDay=${dayOfMonth})`, 'info');
        
        let dayEvents = 0;
        ECONOMIC_EVENTS_SCHEDULE.forEach(template => {
            let shouldInclude = false;
            let reason = '';
            
            if (template.day !== undefined && template.day === dayOfWeek) {
                shouldInclude = true;
                reason = 'weekly match';
            } else if (template.dayOfMonth !== undefined) {
                const variance = Math.abs(template.dayOfMonth - dayOfMonth);
                if (variance <= 2) {
                    shouldInclude = true;
                    reason = `monthly match (target=${template.dayOfMonth}, variance=${variance})`;
                }
            }
            
            if (shouldInclude) {
                dayEvents++;
                const history = MOCK_EVENT_HISTORY[template.name] || {};
                const time = template.time || getRandomMarketTime();
                
                events.push({
                    id: `${template.name}-${dateStr}`,
                    name: template.name,
                    country: template.country,
                    date: dateStr,
                    time: time,
                    impact: template.impact,
                    type: template.type,
                    previous: history.previous || null,
                    forecast: history.forecast || null,
                });
                log(`  + ${template.name} (${reason})`, 'success');
            }
        });
        
        if (dayEvents === 0) {
            log(`  (no events for this day)`, 'info');
        }
    }
    
    events.sort((a, b) => {
        const dateA = new Date(`${a.date}T${a.time}`);
        const dateB = new Date(`${b.date}T${b.time}`);
        return dateA - dateB;
    });
    
    return events;
}

// Run the test
log('Starting Economic Calendar test...', 'info');
log(`ECONOMIC_EVENTS_SCHEDULE has ${ECONOMIC_EVENTS_SCHEDULE.length} templates`, 'info');

const events = generateEconomicEvents();
log(`\nTotal events generated: ${events.length}`, 'success');

// Display events
const eventsDiv = document.getElementById('events');
if (events.length === 0) {
    eventsDiv.innerHTML = '<div class="error">NO EVENTS GENERATED!</div>';
} else {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const today = `${year}-${month}-${day}`;
    
    const upcomingEvents = events.filter(e => e.date >= today).slice(0, 6);
    log(`Upcoming events (>= ${today}): ${upcomingEvents.length}`, 'info');
    
    eventsDiv.innerHTML = events.map(e => `
        <div class="log ${e.date >= today ? 'success' : 'info'}">
            ${e.date === today ? '[TODAY]' : e.date} ${e.time} - ${e.name} (${e.impact})
        </div>
    `).join('');
}
</script>
</body>
</html>
